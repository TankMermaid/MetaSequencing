---
title: "Metagenomic Feature Counts"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE)
options(scipen=999)

library(ggplot2)
library(reshape2)
library(stringr)
library(cowplot)

features=commandArgs(trailingOnly=T)[1]
features=strsplit(features,",")[[1]]

dir=commandArgs(trailingOnly = T)[2]

first=read.table(paste0(dir,"/",features[1],"_combined_counts.tsv"),header=T,row.names=1,sep="\t")

featsum=function(feature,direct){
   cat("# ",feature,"\n")
   data=read.table(paste0(dir,"/",feature,"_combined_counts.tsv"),header=T,row.names=1,sep="\t")
   cat("Identified **`",nrow(data),"`** unique ",feature," across all samples.\n\n")
   #order samples alphabetically
   data=data[,order(colnames(data))]
   #plot the top 10 of each feature, particularly useful for taxa (or all if <10)
   cat("Relative abundance plot for top ",feature," (mean abundance):\n\n")
   abund=t(data/colSums(data))
   means=colMeans(abund)
   abund=abund[,order(means,decreasing = T)]
   top=data.frame(abund)
   colnames(top)=paste0("...",str_sub(colnames(top), start= -30))
   if(ncol(top)>11){
       top=top[,1:10]
       top$Other=rowSums(abund[,11:ncol(abund)])
   }
   top$Sample=rownames(top)
   melted=melt(top,id="Sample")
   colnames(melted)=c("Sample","Feature","Abundance")
   fplot=ggplot(melted,aes(Sample,Abundance,fill=Feature))+geom_bar(stat="identity")+
     scale_fill_brewer(type = "div", palette=9)
   plot(fplot)
   cat("\n\n")
   #pca of samples based on these features
   cat("PCA of samples based on ",feature," abundances:\n\n")
   pca=prcomp(abund)
   pplot=qplot(pca$x[,1],pca$x[,2])+xlab("PC1")+ylab("PC2")+guides(color=F)
   plot(pplot)
   cat("\n\n")
}

```

# Overview

**`r length(features)`** features counted across **`r ncol(first)`** samples.

Features: *`r paste(features)`*

```{r,results='asis',echo=FALSE, fig.width=10}
for(i in features){
  featsum(i,dir)
}
```


